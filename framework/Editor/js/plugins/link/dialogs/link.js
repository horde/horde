CKEDITOR.dialog.add("link",function(ah){var ag=CKEDITOR.plugins.link,af=function(){var d=this.getDialog(),c=d.getContentElement("target","popupFeatures"),b=d.getContentElement("target","linkTargetName"),a=this.getValue();if(!c||!b){return}c=c.getElement();c.hide();b.setValue("");switch(a){case"frame":b.setLabel(ah.lang.link.targetFrameName);b.getElement().show();break;case"popup":c.show();b.setLabel(ah.lang.link.targetPopupName);b.getElement().show();break;default:b.setValue(a);b.getElement().hide();break}},ae=function(){var g=this.getDialog(),f=["urlOptions","anchorOptions","emailOptions"],e=this.getValue(),d=g.definition.getContents("upload"),c=d&&d.hidden;if(e=="url"){if(ah.config.linkShowTargetTab){g.showPage("target")}if(!c){g.showPage("upload")}}else{g.hidePage("target");if(!c){g.hidePage("upload")}}for(var b=0;b<f.length;b++){var a=g.getContentElement("info",f[b]);if(!a){continue}a=a.getElement().getParent().getParent();if(f[b]==e+"Options"){a.show()}else{a.hide()}}},ad=/^javascript:/,ac=/^mailto:([^?]+)(?:\?(.+))?$/,ab=/subject=([^;?:@&=$,\/]*)/,aa=/body=([^;?:@&=$,\/]*)/,Z=/^#(.*)$/,Y=/^((?:http|https|ftp|news):\/\/)?(.*)$/,X=/^(_(?:self|top|parent|blank))$/,W=/^javascript:void\(location\.href='mailto:'\+String\.fromCharCode\(([^)]+)\)(?:\+'(.*)')?\)$/,V=/^javascript:([^(]+)\(([^)]+)\)$/,U=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/,T=/(?:^|,)([^=]+)=(\d+|yes|no)/gi,S=function(v,u){var t=u&&(u.getAttribute("_cke_saved_href")||u.getAttribute("href"))||"",s,r,q,p,o={};if(s=t.match(ad)){if(F=="encode"){t=t.replace(W,function(z,y,x){return"mailto:"+String.fromCharCode.apply(String,y.split(","))+(x&&H(x))})}else{if(F){t.replace(V,function(al,ak,aj){if(ak==E.name){o.type="email";var ai=o.email={},D=/[^,\s]+/g,C=/(^')|('$)/g,B=aj.match(D),A=B.length,z,y;for(var x=0;x<A;x++){y=decodeURIComponent(H(B[x].replace(C,"")));z=E.params[x].toLowerCase();ai[z]=y}ai.address=[ai.name,ai.domain].join("@")}})}}}if(!o.type){if(q=t.match(Z)){o.type="anchor";o.anchor={};o.anchor.name=o.anchor.id=q[1]}else{if(r=t.match(ac)){var n=t.match(ab),m=t.match(aa);o.type="email";var l=o.email={};l.address=r[1];n&&(l.subject=decodeURIComponent(n[1]));m&&(l.body=decodeURIComponent(m[1]))}else{if(t&&(p=t.match(Y))){o.type="url";o.url={};o.url.protocol=p[1];o.url.url=p[2]}else{o.type="url"}}}}if(u){var k=u.getAttribute("target");o.target={};o.adv={};if(!k){var j=u.getAttribute("_cke_pa_onclick")||u.getAttribute("onclick"),i=j&&j.match(U);if(i){o.target.type="popup";o.target.name=i[1];var h;while(h=T.exec(i[2])){if(h[2]=="yes"||h[2]=="1"){o.target[h[1]]=true}else{if(isFinite(h[2])){o.target[h[1]]=h[2]}}}}}else{var g=k.match(X);if(g){o.target.type=o.target.name=k}else{o.target.type="frame";o.target.name=k}}var f=this,e=function(z,y){var x=u.getAttribute(y);if(x!==null){o.adv[z]=x||""}};e("advId","id");e("advLangDir","dir");e("advAccessKey","accessKey");e("advName","name");e("advLangCode","lang");e("advTabIndex","tabindex");e("advTitle","title");e("advContentType","type");e("advCSSClasses","class");e("advCharset","charset");e("advStyles","style")}var d=v.document.getElementsByTag("img"),c=new CKEDITOR.dom.nodeList(v.document.$.anchors),b=o.anchors=[];for(var a=0;a<d.count();a++){var w=d.getItem(a);if(w.getAttribute("_cke_realelement")&&w.getAttribute("_cke_real_element_type")=="anchor"){b.push(v.restoreRealElement(w))}}for(a=0;a<c.count();a++){b.push(c.getItem(a))}for(a=0;a<b.length;a++){w=b[a];b[a]={name:w.getAttribute("name"),id:w.getAttribute("id")}}this._.selectedElement=u;return o},Q=function(b,a){if(a[b]){this.setValue(a[b][this.id]||"")}},O=function(a){return Q.call(this,"target",a)},M=function(a){return Q.call(this,"adv",a)},K=function(b,a){if(!a[b]){a[b]={}}a[b][this.id]=this.getValue()||""},J=function(a){return K.call(this,"target",a)},I=function(a){return K.call(this,"adv",a)};function H(a){return a.replace(/\\'/g,"'")}function G(a){return a.replace(/'/g,"\\$&")}var F=ah.config.emailProtection||"";if(F&&F!="encode"){var E={};F.replace(/^([^(]+)\(([^)]+)\)$/,function(c,b,a){E.name=b;E.params=[];a.replace(/[^,\s]+/g,function(d){E.params.push(d)})})}function R(g){var f,e=E.name,d=E.params,c,b;f=[e,"("];for(var a=0;a<d.length;a++){c=d[a].toLowerCase();b=g[c];a>0&&f.push(",");f.push("'",b?G(encodeURIComponent(g[c])):"","'")}f.push(")");return f.join("")}function P(e){var d,c=e.length,b=[];for(var a=0;a<c;a++){d=e.charCodeAt(a);b.push(d)}return"String.fromCharCode("+b.join(",")+")"}var N=ah.lang.common,L=ah.lang.link;return{title:L.title,minWidth:350,minHeight:230,contents:[{id:"info",label:L.info,title:L.info,elements:[{id:"linkType",type:"select",label:L.type,"default":"url",items:[[L.toUrl,"url"],[L.toAnchor,"anchor"],[L.toEmail,"email"]],onChange:ae,setup:function(a){if(a.type){this.setValue(a.type)}},commit:function(a){a.type=this.getValue()}},{type:"vbox",id:"urlOptions",children:[{type:"hbox",widths:["25%","75%"],children:[{id:"protocol",type:"select",label:N.protocol,"default":"http://",items:[["http://","http://"],["https://","https://"],["ftp://","ftp://"],["news://","news://"],[L.other,""]],setup:function(a){if(a.url){this.setValue(a.url.protocol||"")}},commit:function(a){if(!a.url){a.url={}}a.url.protocol=this.getValue()}},{type:"text",id:"url",label:N.url,required:true,onLoad:function(){this.allowOnChange=true},onKeyUp:function(){var a=this;a.allowOnChange=false;var f=a.getDialog().getContentElement("info","protocol"),e=a.getValue(),d=/^(http|https|ftp|news):\/\/(?=.)/gi,c=/^((javascript:)|[#\/\.\?])/gi,b=d.exec(e);if(b){a.setValue(e.substr(b[0].length));f.setValue(b[0].toLowerCase())}else{if(c.test(e)){f.setValue("")}}a.allowOnChange=true},onChange:function(){if(this.allowOnChange){this.onKeyUp()}},validate:function(){var b=this.getDialog();if(b.getContentElement("info","linkType")&&b.getValueOf("info","linkType")!="url"){return true}if(this.getDialog().fakeObj){return true}var a=CKEDITOR.dialog.validate.notEmpty(L.noUrl);return a.apply(this)},setup:function(a){this.allowOnChange=false;if(a.url){this.setValue(a.url.url)}this.allowOnChange=true},commit:function(a){this.onChange();if(!a.url){a.url={}}a.url.url=this.getValue();this.allowOnChange=false}}],setup:function(a){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().show()}}},{type:"button",id:"browse",hidden:"true",filebrowser:"info:url",label:N.browseServer}]},{type:"vbox",id:"anchorOptions",width:260,align:"center",padding:0,children:[{type:"fieldset",id:"selectAnchorText",label:L.selectAnchor,setup:function(a){if(a.anchors.length>0){this.getElement().show()}else{this.getElement().hide()}},children:[{type:"hbox",id:"selectAnchor",children:[{type:"select",id:"anchorName","default":"",label:L.anchorName,style:"width: 100%;",items:[[""]],setup:function(d){var a=this;a.clear();a.add("");for(var c=0;c<d.anchors.length;c++){if(d.anchors[c].name){a.add(d.anchors[c].name)}}if(d.anchor){a.setValue(d.anchor.name)}var b=a.getDialog().getContentElement("info","linkType");if(b&&b.getValue()=="email"){a.focus()}},commit:function(a){if(!a.anchor){a.anchor={}}a.anchor.name=this.getValue()}},{type:"select",id:"anchorId","default":"",label:L.anchorId,style:"width: 100%;",items:[[""]],setup:function(c){var a=this;a.clear();a.add("");for(var b=0;b<c.anchors.length;b++){if(c.anchors[b].id){a.add(c.anchors[b].id)}}if(c.anchor){a.setValue(c.anchor.id)}},commit:function(a){if(!a.anchor){a.anchor={}}a.anchor.id=this.getValue()}}],setup:function(a){if(a.anchors.length>0){this.getElement().show()}else{this.getElement().hide()}}}]},{type:"html",id:"noAnchors",style:"text-align: center;",html:'<div role="label" tabIndex="-1">'+CKEDITOR.tools.htmlEncode(L.noAnchors)+"</div>",focus:true,setup:function(a){if(a.anchors.length<1){this.getElement().show()}else{this.getElement().hide()}}}],setup:function(a){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().hide()}}},{type:"vbox",id:"emailOptions",padding:1,children:[{type:"text",id:"emailAddress",label:L.emailAddress,required:true,validate:function(){var b=this.getDialog();if(!b.getContentElement("info","linkType")||b.getValueOf("info","linkType")!="email"){return true}var a=CKEDITOR.dialog.validate.notEmpty(L.noEmail);return a.apply(this)},setup:function(b){if(b.email){this.setValue(b.email.address)}var a=this.getDialog().getContentElement("info","linkType");if(a&&a.getValue()=="email"){this.select()}},commit:function(a){if(!a.email){a.email={}}a.email.address=this.getValue()}},{type:"text",id:"emailSubject",label:L.emailSubject,setup:function(a){if(a.email){this.setValue(a.email.subject)}},commit:function(a){if(!a.email){a.email={}}a.email.subject=this.getValue()}},{type:"textarea",id:"emailBody",label:L.emailBody,rows:3,"default":"",setup:function(a){if(a.email){this.setValue(a.email.body)}},commit:function(a){if(!a.email){a.email={}}a.email.body=this.getValue()}}],setup:function(a){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().hide()}}}]},{id:"target",label:L.target,title:L.target,elements:[{type:"hbox",widths:["50%","50%"],children:[{type:"select",id:"linkTargetType",label:N.target,"default":"notSet",style:"width : 100%;",items:[[N.notSet,"notSet"],[L.targetFrame,"frame"],[L.targetPopup,"popup"],[N.targetNew,"_blank"],[N.targetTop,"_top"],[N.targetSelf,"_self"],[N.targetParent,"_parent"]],onChange:af,setup:function(a){if(a.target){this.setValue(a.target.type)}af.call(this)},commit:function(a){if(!a.target){a.target={}}a.target.type=this.getValue()}},{type:"text",id:"linkTargetName",label:L.targetFrameName,"default":"",setup:function(a){if(a.target){this.setValue(a.target.name)}},commit:function(a){if(!a.target){a.target={}}a.target.name=this.getValue().replace(/\W/gi,"")}}]},{type:"vbox",width:260,align:"center",padding:2,id:"popupFeatures",children:[{type:"fieldset",label:L.popupFeatures,children:[{type:"hbox",children:[{type:"checkbox",id:"resizable",label:L.popupResizable,setup:O,commit:J},{type:"checkbox",id:"status",label:L.popupStatusBar,setup:O,commit:J}]},{type:"hbox",children:[{type:"checkbox",id:"location",label:L.popupLocationBar,setup:O,commit:J},{type:"checkbox",id:"toolbar",label:L.popupToolbar,setup:O,commit:J}]},{type:"hbox",children:[{type:"checkbox",id:"menubar",label:L.popupMenuBar,setup:O,commit:J},{type:"checkbox",id:"fullscreen",label:L.popupFullScreen,setup:O,commit:J}]},{type:"hbox",children:[{type:"checkbox",id:"scrollbars",label:L.popupScrollBars,setup:O,commit:J},{type:"checkbox",id:"dependent",label:L.popupDependent,setup:O,commit:J}]},{type:"hbox",children:[{type:"text",widths:["30%","70%"],labelLayout:"horizontal",label:L.popupWidth,id:"width",setup:O,commit:J},{type:"text",labelLayout:"horizontal",widths:["55%","45%"],label:L.popupLeft,id:"left",setup:O,commit:J}]},{type:"hbox",children:[{type:"text",labelLayout:"horizontal",widths:["30%","70%"],label:L.popupHeight,id:"height",setup:O,commit:J},{type:"text",labelLayout:"horizontal",label:L.popupTop,widths:["55%","45%"],id:"top",setup:O,commit:J}]}]}]}]},{id:"upload",label:L.upload,title:L.upload,hidden:true,filebrowser:"uploadButton",elements:[{type:"file",id:"upload",label:N.upload,style:"height:40px",size:29},{type:"fileButton",id:"uploadButton",label:N.uploadSubmit,filebrowser:"info:url","for":["upload","upload"]}]},{id:"advanced",label:L.advanced,title:L.advanced,elements:[{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",id:"advId",label:L.id,setup:M,commit:I},{type:"select",id:"advLangDir",label:L.langDir,"default":"",style:"width:110px",items:[[N.notSet,""],[L.langDirLTR,"ltr"],[L.langDirRTL,"rtl"]],setup:M,commit:I},{type:"text",id:"advAccessKey",width:"80px",label:L.acccessKey,maxLength:1,setup:M,commit:I}]},{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",label:L.name,id:"advName",setup:M,commit:I},{type:"text",label:L.langCode,id:"advLangCode",width:"110px","default":"",setup:M,commit:I},{type:"text",label:L.tabIndex,id:"advTabIndex",width:"80px",maxLength:5,setup:M,commit:I}]}]},{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:L.advisoryTitle,"default":"",id:"advTitle",setup:M,commit:I},{type:"text",label:L.advisoryContentType,"default":"",id:"advContentType",setup:M,commit:I}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:L.cssClasses,"default":"",id:"advCSSClasses",setup:M,commit:I},{type:"text",label:L.charset,"default":"",id:"advCharset",setup:M,commit:I}]},{type:"hbox",children:[{type:"text",label:L.styles,"default":"",id:"advStyles",setup:M,commit:I}]}]}]}],onShow:function(){var a=this;a.fakeObj=false;var d=a.getParentEditor(),c=d.getSelection(),b=null;if((b=ag.getSelectedLink(d))&&b.hasAttribute("href")){c.selectElement(b)}else{if((b=c.getSelectedElement())&&b.is("img")&&b.getAttribute("_cke_real_element_type")&&b.getAttribute("_cke_real_element_type")=="anchor"){a.fakeObj=b;b=d.restoreRealElement(a.fakeObj);c.selectElement(a.fakeObj)}else{b=null}}a.setupContent(S.apply(a,[d,b]))},onOk:function(){var v={href:"javascript:void(0)/*"+CKEDITOR.tools.getNextNumber()+"*/"},u=[],t={href:v.href},s=this,r=this.getParentEditor();this.commitContent(t);switch(t.type||"url"){case"url":var q=t.url&&t.url.protocol!=undefined?t.url.protocol:"http://",p=t.url&&t.url.url||"";v._cke_saved_href=p.indexOf("/")===0?p:q+p;break;case"anchor":var o=t.anchor&&t.anchor.name,n=t.anchor&&t.anchor.id;v._cke_saved_href="#"+(o||n||"");break;case"email":var m,l=t.email,k=l.address;switch(F){case"":case"encode":var j=encodeURIComponent(l.subject||""),i=encodeURIComponent(l.body||""),h=[];j&&h.push("subject="+j);i&&h.push("body="+i);h=h.length?"?"+h.join("&"):"";if(F=="encode"){m=["javascript:void(location.href='mailto:'+",P(k)];h&&m.push("+'",G(h),"'");m.push(")")}else{m=["mailto:",k,h]}break;default:var g=k.split("@",2);l.name=g[0];l.domain=g[1];m=["javascript:",R(l)]}v._cke_saved_href=m.join("");break}if(t.target){if(t.target.type=="popup"){var f=["window.open(this.href, '",t.target.name||"","', '"],e=["resizable","status","location","toolbar","menubar","fullscreen","scrollbars","dependent"],d=e.length,c=function(ak){if(t.target[ak]){e.push(ak+"="+t.target[ak])}};for(var b=0;b<d;b++){e[b]=e[b]+(t.target[e[b]]?"=yes":"=no")}c("width");c("left");c("height");c("top");f.push(e.join(","),"'); return false;");v._cke_pa_onclick=f.join("");u.push("target")}else{if(t.target.type!="notSet"&&t.target.name){v.target=t.target.name}else{u.push("target")}u.push("_cke_pa_onclick","onclick")}}if(t.adv){var a=function(ao,an){var am=t.adv[ao];if(am){v[an]=am}else{u.push(an)}};if(this._.selectedElement){a("advId","id")}a("advLangDir","dir");a("advAccessKey","accessKey");a("advName","name");a("advLangCode","lang");a("advTabIndex","tabindex");a("advTitle","title");a("advContentType","type");a("advCSSClasses","class");a("advCharset","charset");a("advStyles","style")}if(!this._.selectedElement){var ai=r.getSelection(),D=ai.getRanges(true);if(D.length==1&&D[0].collapsed){var C=new CKEDITOR.dom.text(t.type=="email"?t.email.address:v._cke_saved_href,r.document);D[0].insertNode(C);D[0].selectNodeContents(C);ai.selectRanges(D)}var B=new CKEDITOR.style({element:"a",attributes:v});B.type=CKEDITOR.STYLE_INLINE;B.apply(r.document);if(t.adv&&t.adv.advId){var A=this.getParentEditor().document.$.getElementsByTagName("a");for(b=0;b<A.length;b++){if(A[b].href==v.href){A[b].id=t.adv.advId;break}}}}else{var z=this._.selectedElement,y=z.getAttribute("_cke_saved_href"),x=z.getHtml();if(CKEDITOR.env.ie&&v.name!=z.getAttribute("name")){var w=new CKEDITOR.dom.element('<a name="'+CKEDITOR.tools.htmlEncode(v.name)+'">',r.document);ai=r.getSelection();z.moveChildren(w);z.copyAttributes(w,{name:1});w.replace(z);z=w;ai.selectElement(z)}z.setAttributes(v);z.removeAttributes(u);if(y==x||t.type=="email"&&x.indexOf("@")!=-1){z.setHtml(t.type=="email"?t.email.address:v._cke_saved_href)}if(z.getAttribute("name")){z.addClass("cke_anchor")}else{z.removeClass("cke_anchor")}if(this.fakeObj){r.createFakeElement(z,"cke_anchor","anchor").replace(this.fakeObj)}delete this._.selectedElement}},onLoad:function(){if(!ah.config.linkShowAdvancedTab){this.hidePage("advanced")}if(!ah.config.linkShowTargetTab){this.hidePage("target")}},onFocus:function(){var b=this.getContentElement("info","linkType"),a;if(b&&b.getValue()=="url"){a=this.getContentElement("info","url");a.select()}}}});