CKEDITOR.dialog.add("link",function(aj){var ai=CKEDITOR.plugins.link,ah=function(){var d=this.getDialog(),c=d.getContentElement("target","popupFeatures"),b=d.getContentElement("target","linkTargetName"),a=this.getValue();if(!c||!b){return}c=c.getElement();c.hide();b.setValue("");switch(a){case"frame":b.setLabel(aj.lang.link.targetFrameName);b.getElement().show();break;case"popup":c.show();b.setLabel(aj.lang.link.targetPopupName);b.getElement().show();break;default:b.setValue(a);b.getElement().hide();break}},ag=function(){var g=this.getDialog(),f=["urlOptions","anchorOptions","emailOptions"],e=this.getValue(),d=g.definition.getContents("upload"),c=d&&d.hidden;if(e=="url"){if(aj.config.linkShowTargetTab){g.showPage("target")}if(!c){g.showPage("upload")}}else{g.hidePage("target");if(!c){g.hidePage("upload")}}for(var b=0;b<f.length;b++){var a=g.getContentElement("info",f[b]);if(!a){continue}a=a.getElement().getParent().getParent();if(f[b]==e+"Options"){a.show()}else{a.hide()}}g.layout()},af=/^javascript:/,ae=/^mailto:([^?]+)(?:\?(.+))?$/,ad=/subject=([^;?:@&=$,\/]*)/,ac=/body=([^;?:@&=$,\/]*)/,ab=/^#(.*)$/,aa=/^((?:http|https|ftp|news):\/\/)?(.*)$/,Z=/^(_(?:self|top|parent|blank))$/,Y=/^javascript:void\(location\.href='mailto:'\+String\.fromCharCode\(([^)]+)\)(?:\+'(.*)')?\)$/,X=/^javascript:([^(]+)\(([^)]+)\)$/,W=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/,V=/(?:^|,)([^=]+)=(\d+|yes|no)/gi,U=function(u,t){var s=t&&(t.data("cke-saved-href")||t.getAttribute("href"))||"",r,q,p,o,n={};if(r=s.match(af)){if(G=="encode"){s=s.replace(Y,function(B,A,z){return"mailto:"+String.fromCharCode.apply(String,A.split(","))+(z&&I(z))})}else{if(G){s.replace(X,function(ao,an,am){if(an==F.name){n.type="email";var al=n.email={},ak=/[^,\s]+/g,E=/(^')|('$)/g,D=am.match(ak),C=D.length,B,A;for(var z=0;z<C;z++){A=decodeURIComponent(I(D[z].replace(E,"")));B=F.params[z].toLowerCase();al[B]=A}al.address=[al.name,al.domain].join("@")}})}}}if(!n.type){if(p=s.match(ab)){n.type="anchor";n.anchor={};n.anchor.name=n.anchor.id=p[1]}else{if(q=s.match(ae)){var m=s.match(ad),l=s.match(ac);n.type="email";var k=n.email={};k.address=q[1];m&&(k.subject=decodeURIComponent(m[1]));l&&(k.body=decodeURIComponent(l[1]))}else{if(s&&(o=s.match(aa))){n.type="url";n.url={};n.url.protocol=o[1];n.url.url=o[2]}else{n.type="url"}}}}if(t){var j=t.getAttribute("target");n.target={};n.adv={};if(!j){var i=t.data("cke-pa-onclick")||t.getAttribute("onclick"),h=i&&i.match(W);if(h){n.target.type="popup";n.target.name=h[1];var g;while(g=V.exec(h[2])){if((g[2]=="yes"||g[2]=="1")&&!(g[1] in {height:1,width:1,top:1,left:1})){n.target[g[1]]=true}else{if(isFinite(g[2])){n.target[g[1]]=g[2]}}}}}else{var f=j.match(Z);if(f){n.target.type=n.target.name=j}else{n.target.type="frame";n.target.name=j}}var e=this,d=function(B,A){var z=t.getAttribute(A);if(z!==null){n.adv[B]=z||""}};d("advId","id");d("advLangDir","dir");d("advAccessKey","accessKey");n.adv.advName=t.data("cke-saved-name")||t.getAttribute("name")||"";d("advLangCode","lang");d("advTabIndex","tabindex");d("advTitle","title");d("advContentType","type");CKEDITOR.plugins.link.synAnchorSelector?n.adv.advCSSClasses=P(t):d("advCSSClasses","class");d("advCharset","charset");d("advStyles","style");d("advRel","rel")}var c=n.anchors=[],b,a,y;if(CKEDITOR.plugins.link.emptyAnchorFix){var x=u.document.getElementsByTag("a");for(b=0,a=x.count();b<a;b++){y=x.getItem(b);if(y.data("cke-saved-name")||y.hasAttribute("name")){c.push({name:y.data("cke-saved-name")||y.getAttribute("name"),id:y.getAttribute("id")})}}}else{var w=new CKEDITOR.dom.nodeList(u.document.$.anchors);for(b=0,a=w.count();b<a;b++){y=w.getItem(b);c[b]={name:y.getAttribute("name"),id:y.getAttribute("id")}}}if(CKEDITOR.plugins.link.fakeAnchor){var v=u.document.getElementsByTag("img");for(b=0,a=v.count();b<a;b++){if(y=CKEDITOR.plugins.link.tryRestoreFakeAnchor(u,v.getItem(b))){c.push({name:y.getAttribute("name"),id:y.getAttribute("id")})}}}this._.selectedElement=t;return n},S=function(b,a){if(a[b]){this.setValue(a[b][this.id]||"")}},Q=function(a){return S.call(this,"target",a)},O=function(a){return S.call(this,"adv",a)},M=function(b,a){if(!a[b]){a[b]={}}a[b][this.id]=this.getValue()||""},K=function(a){return M.call(this,"target",a)},J=function(a){return M.call(this,"adv",a)};function I(a){return a.replace(/\\'/g,"'")}function H(a){return a.replace(/'/g,"\\$&")}var G=aj.config.emailProtection||"";if(G&&G!="encode"){var F={};G.replace(/^([^(]+)\(([^)]+)\)$/,function(c,b,a){F.name=b;F.params=[];a.replace(/[^,\s]+/g,function(d){F.params.push(d)})})}function T(g){var f,e=F.name,d=F.params,c,b;f=[e,"("];for(var a=0;a<d.length;a++){c=d[a].toLowerCase();b=g[c];a>0&&f.push(",");f.push("'",b?H(encodeURIComponent(g[c])):"","'")}f.push(")");return f.join("")}function R(e){var d,c=e.length,b=[];for(var a=0;a<c;a++){d=e.charCodeAt(a);b.push(d)}return"String.fromCharCode("+b.join(",")+")"}function P(b){var a=b.getAttribute("class");return a?a.replace(/\s*(?:cke_anchor_empty|cke_anchor)(?:\s*$)?/g,""):""}var N=aj.lang.common,L=aj.lang.link;return{title:L.title,minWidth:350,minHeight:230,contents:[{id:"info",label:L.info,title:L.info,elements:[{id:"linkType",type:"select",label:L.type,"default":"url",items:[[L.toUrl,"url"],[L.toAnchor,"anchor"],[L.toEmail,"email"]],onChange:ag,setup:function(a){if(a.type){this.setValue(a.type)}},commit:function(a){a.type=this.getValue()}},{type:"vbox",id:"urlOptions",children:[{type:"hbox",widths:["25%","75%"],children:[{id:"protocol",type:"select",label:N.protocol,"default":"http://",items:[["http://","http://"],["https://","https://"],["ftp://","ftp://"],["news://","news://"],[L.other,""]],setup:function(a){if(a.url){this.setValue(a.url.protocol||"")}},commit:function(a){if(!a.url){a.url={}}a.url.protocol=this.getValue()}},{type:"text",id:"url",label:N.url,required:true,onLoad:function(){this.allowOnChange=true},onKeyUp:function(){var a=this;a.allowOnChange=false;var f=a.getDialog().getContentElement("info","protocol"),e=a.getValue(),d=/^(http|https|ftp|news):\/\/(?=.)/i,c=/^((javascript:)|[#\/\.\?])/i,b=d.exec(e);if(b){a.setValue(e.substr(b[0].length));f.setValue(b[0].toLowerCase())}else{if(c.test(e)){f.setValue("")}}a.allowOnChange=true},onChange:function(){if(this.allowOnChange){this.onKeyUp()}},validate:function(){var b=this.getDialog();if(b.getContentElement("info","linkType")&&b.getValueOf("info","linkType")!="url"){return true}if(this.getDialog().fakeObj){return true}var a=CKEDITOR.dialog.validate.notEmpty(L.noUrl);return a.apply(this)},setup:function(a){this.allowOnChange=false;if(a.url){this.setValue(a.url.url)}this.allowOnChange=true},commit:function(a){this.onChange();if(!a.url){a.url={}}a.url.url=this.getValue();this.allowOnChange=false}}],setup:function(a){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().show()}}},{type:"button",id:"browse",hidden:"true",filebrowser:"info:url",label:N.browseServer}]},{type:"vbox",id:"anchorOptions",width:260,align:"center",padding:0,children:[{type:"fieldset",id:"selectAnchorText",label:L.selectAnchor,setup:function(a){if(a.anchors.length>0){this.getElement().show()}else{this.getElement().hide()}},children:[{type:"hbox",id:"selectAnchor",children:[{type:"select",id:"anchorName","default":"",label:L.anchorName,style:"width: 100%;",items:[[""]],setup:function(d){var a=this;a.clear();a.add("");for(var c=0;c<d.anchors.length;c++){if(d.anchors[c].name){a.add(d.anchors[c].name)}}if(d.anchor){a.setValue(d.anchor.name)}var b=a.getDialog().getContentElement("info","linkType");if(b&&b.getValue()=="email"){a.focus()}},commit:function(a){if(!a.anchor){a.anchor={}}a.anchor.name=this.getValue()}},{type:"select",id:"anchorId","default":"",label:L.anchorId,style:"width: 100%;",items:[[""]],setup:function(c){var a=this;a.clear();a.add("");for(var b=0;b<c.anchors.length;b++){if(c.anchors[b].id){a.add(c.anchors[b].id)}}if(c.anchor){a.setValue(c.anchor.id)}},commit:function(a){if(!a.anchor){a.anchor={}}a.anchor.id=this.getValue()}}],setup:function(a){if(a.anchors.length>0){this.getElement().show()}else{this.getElement().hide()}}}]},{type:"html",id:"noAnchors",style:"text-align: center;",html:'<div role="note" tabIndex="-1">'+CKEDITOR.tools.htmlEncode(L.noAnchors)+"</div>",focus:true,setup:function(a){if(a.anchors.length<1){this.getElement().show()}else{this.getElement().hide()}}}],setup:function(a){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().hide()}}},{type:"vbox",id:"emailOptions",padding:1,children:[{type:"text",id:"emailAddress",label:L.emailAddress,required:true,validate:function(){var b=this.getDialog();if(!b.getContentElement("info","linkType")||b.getValueOf("info","linkType")!="email"){return true}var a=CKEDITOR.dialog.validate.notEmpty(L.noEmail);return a.apply(this)},setup:function(b){if(b.email){this.setValue(b.email.address)}var a=this.getDialog().getContentElement("info","linkType");if(a&&a.getValue()=="email"){this.select()}},commit:function(a){if(!a.email){a.email={}}a.email.address=this.getValue()}},{type:"text",id:"emailSubject",label:L.emailSubject,setup:function(a){if(a.email){this.setValue(a.email.subject)}},commit:function(a){if(!a.email){a.email={}}a.email.subject=this.getValue()}},{type:"textarea",id:"emailBody",label:L.emailBody,rows:3,"default":"",setup:function(a){if(a.email){this.setValue(a.email.body)}},commit:function(a){if(!a.email){a.email={}}a.email.body=this.getValue()}}],setup:function(a){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().hide()}}}]},{id:"target",label:L.target,title:L.target,elements:[{type:"hbox",widths:["50%","50%"],children:[{type:"select",id:"linkTargetType",label:N.target,"default":"notSet",style:"width : 100%;",items:[[N.notSet,"notSet"],[L.targetFrame,"frame"],[L.targetPopup,"popup"],[N.targetNew,"_blank"],[N.targetTop,"_top"],[N.targetSelf,"_self"],[N.targetParent,"_parent"]],onChange:ah,setup:function(a){if(a.target){this.setValue(a.target.type||"notSet")}ah.call(this)},commit:function(a){if(!a.target){a.target={}}a.target.type=this.getValue()}},{type:"text",id:"linkTargetName",label:L.targetFrameName,"default":"",setup:function(a){if(a.target){this.setValue(a.target.name)}},commit:function(a){if(!a.target){a.target={}}a.target.name=this.getValue().replace(/\W/gi,"")}}]},{type:"vbox",width:"100%",align:"center",padding:2,id:"popupFeatures",children:[{type:"fieldset",label:L.popupFeatures,children:[{type:"hbox",children:[{type:"checkbox",id:"resizable",label:L.popupResizable,setup:Q,commit:K},{type:"checkbox",id:"status",label:L.popupStatusBar,setup:Q,commit:K}]},{type:"hbox",children:[{type:"checkbox",id:"location",label:L.popupLocationBar,setup:Q,commit:K},{type:"checkbox",id:"toolbar",label:L.popupToolbar,setup:Q,commit:K}]},{type:"hbox",children:[{type:"checkbox",id:"menubar",label:L.popupMenuBar,setup:Q,commit:K},{type:"checkbox",id:"fullscreen",label:L.popupFullScreen,setup:Q,commit:K}]},{type:"hbox",children:[{type:"checkbox",id:"scrollbars",label:L.popupScrollBars,setup:Q,commit:K},{type:"checkbox",id:"dependent",label:L.popupDependent,setup:Q,commit:K}]},{type:"hbox",children:[{type:"text",widths:["50%","50%"],labelLayout:"horizontal",label:N.width,id:"width",setup:Q,commit:K},{type:"text",labelLayout:"horizontal",widths:["50%","50%"],label:L.popupLeft,id:"left",setup:Q,commit:K}]},{type:"hbox",children:[{type:"text",labelLayout:"horizontal",widths:["50%","50%"],label:N.height,id:"height",setup:Q,commit:K},{type:"text",labelLayout:"horizontal",label:L.popupTop,widths:["50%","50%"],id:"top",setup:Q,commit:K}]}]}]}]},{id:"upload",label:L.upload,title:L.upload,hidden:true,filebrowser:"uploadButton",elements:[{type:"file",id:"upload",label:N.upload,style:"height:40px",size:29},{type:"fileButton",id:"uploadButton",label:N.uploadSubmit,filebrowser:"info:url","for":["upload","upload"]}]},{id:"advanced",label:L.advanced,title:L.advanced,elements:[{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",id:"advId",label:L.id,setup:O,commit:J},{type:"select",id:"advLangDir",label:L.langDir,"default":"",style:"width:110px",items:[[N.notSet,""],[L.langDirLTR,"ltr"],[L.langDirRTL,"rtl"]],setup:O,commit:J},{type:"text",id:"advAccessKey",width:"80px",label:L.acccessKey,maxLength:1,setup:O,commit:J}]},{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",label:L.name,id:"advName",setup:O,commit:J},{type:"text",label:L.langCode,id:"advLangCode",width:"110px","default":"",setup:O,commit:J},{type:"text",label:L.tabIndex,id:"advTabIndex",width:"80px",maxLength:5,setup:O,commit:J}]}]},{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:L.advisoryTitle,"default":"",id:"advTitle",setup:O,commit:J},{type:"text",label:L.advisoryContentType,"default":"",id:"advContentType",setup:O,commit:J}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:L.cssClasses,"default":"",id:"advCSSClasses",setup:O,commit:J},{type:"text",label:L.charset,"default":"",id:"advCharset",setup:O,commit:J}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:L.rel,"default":"",id:"advRel",setup:O,commit:J},{type:"text",label:L.styles,"default":"",id:"advStyles",validate:CKEDITOR.dialog.validate.inlineStyle(aj.lang.common.invalidInlineStyle),setup:O,commit:J}]}]}]}],onShow:function(){var c=this.getParentEditor(),b=c.getSelection(),a=null;if((a=ai.getSelectedLink(c))&&a.hasAttribute("href")){b.selectElement(a)}else{a=null}this.setupContent(U.apply(this,[c,a]))},onOk:function(){var u={},t=[],s={},r=this,q=this.getParentEditor();this.commitContent(s);switch(s.type||"url"){case"url":var p=s.url&&s.url.protocol!=undefined?s.url.protocol:"http://",o=s.url&&CKEDITOR.tools.trim(s.url.url)||"";u["data-cke-saved-href"]=o.indexOf("/")===0?o:p+o;break;case"anchor":var n=s.anchor&&s.anchor.name,m=s.anchor&&s.anchor.id;u["data-cke-saved-href"]="#"+(n||m||"");break;case"email":var l,k=s.email,j=k.address;switch(G){case"":case"encode":var i=encodeURIComponent(k.subject||""),h=encodeURIComponent(k.body||""),g=[];i&&g.push("subject="+i);h&&g.push("body="+h);g=g.length?"?"+g.join("&"):"";if(G=="encode"){l=["javascript:void(location.href='mailto:'+",R(j)];g&&l.push("+'",H(g),"'");l.push(")")}else{l=["mailto:",j,g]}break;default:var f=j.split("@",2);k.name=f[0];k.domain=f[1];l=["javascript:",T(k)]}u["data-cke-saved-href"]=l.join("");break}if(s.target){if(s.target.type=="popup"){var e=["window.open(this.href, '",s.target.name||"","', '"],d=["resizable","status","location","toolbar","menubar","fullscreen","scrollbars","dependent"],c=d.length,b=function(D){if(s.target[D]){d.push(D+"="+s.target[D])}};for(var a=0;a<c;a++){d[a]=d[a]+(s.target[d[a]]?"=yes":"=no")}b("width");b("left");b("height");b("top");e.push(d.join(","),"'); return false;");u["data-cke-pa-onclick"]=e.join("");t.push("target")}else{if(s.target.type!="notSet"&&s.target.name){u.target=s.target.name}else{t.push("target")}t.push("data-cke-pa-onclick","onclick")}}if(s.adv){var C=function(D,ak){var E=s.adv[D];if(E){u[ak]=E}else{t.push(ak)}};C("advId","id");C("advLangDir","dir");C("advAccessKey","accessKey");if(s.adv.advName){u.name=u["data-cke-saved-name"]=s.adv.advName}else{t=t.concat(["data-cke-saved-name","name"])}C("advLangCode","lang");C("advTabIndex","tabindex");C("advTitle","title");C("advContentType","type");C("advCSSClasses","class");C("advCharset","charset");C("advStyles","style");C("advRel","rel")}var B=q.getSelection();u.href=u["data-cke-saved-href"];if(!this._.selectedElement){var A=B.getRanges(true);if(A.length==1&&A[0].collapsed){var z=new CKEDITOR.dom.text(s.type=="email"?s.email.address:u["data-cke-saved-href"],q.document);A[0].insertNode(z);A[0].selectNodeContents(z);B.selectRanges(A)}var y=new CKEDITOR.style({element:"a",attributes:u});y.type=CKEDITOR.STYLE_INLINE;y.apply(q.document)}else{var x=this._.selectedElement,w=x.data("cke-saved-href"),v=x.getHtml();x.setAttributes(u);x.removeAttributes(t);if(s.adv&&s.adv.advName&&CKEDITOR.plugins.link.synAnchorSelector){x.addClass(x.getChildCount()?"cke_anchor":"cke_anchor_empty")}if(w==v||s.type=="email"&&v.indexOf("@")!=-1){x.setHtml(s.type=="email"?s.email.address:u["data-cke-saved-href"])}B.selectElement(x);delete this._.selectedElement}},onLoad:function(){if(!aj.config.linkShowAdvancedTab){this.hidePage("advanced")}if(!aj.config.linkShowTargetTab){this.hidePage("target")}},onFocus:function(){var b=this.getContentElement("info","linkType"),a;if(b&&b.getValue()=="url"){a=this.getContentElement("info","url");a.select()}}}});