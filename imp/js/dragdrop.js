var DragDrop={Drags:{drags:$H(),register:function(A){if(!this.drags.size()){if(!this.div){this.div=new Element("DIV",{className:A.options.classname}).hide()}$(document.body).insert(this.div)}this.drags.set(A.element.readAttribute("id"),A)},unregister:function(A){if(this.drag==A.element){this.drag.deactivate()}this.drags.unset(A.element.readAttribute("id"));if(!this.drags.size()&&this.div){this.div.remove()}},get_drag:function(A){return this.drags.get(Object.isElement(A)?$(A).readAttribute("id"):A)},activate:function(A){if(this.drag){this.deactivate()}this.drag=A;this.mousemoveE=A._mouseMove.bindAsEventListener(A);this.mouseupE=A._mouseUp.bindAsEventListener(A);document.observe("mousemove",this.mousemoveE);document.observe("mouseup",this.mouseupE)},deactivate:function(){if(this.drag){this.drag=null;document.stopObserving("mousemove",this.mousemoveE);document.stopObserving("mouseup",this.mouseupE)}}},Drops:{drops:$H(),register:function(A){this.drops.set(A.element.readAttribute("id"),A)},unregister:function(A){if(this.drop==A.element){this.drop=null}this.drops.unset(A.element.readAttribute("id"))},get_drop:function(A){return this.drops.get(Object.isElement(A)?$(A).readAttribute("id"):A)}},validDrop:function(A){var B=DragDrop.Drops.drop;return(B&&A&&A!=B.element&&(!B.options.accept.size()||B.options.accept.include(A.tagName)))}},Drag=Class.create({initialize:function(A){this.element=$(A);this.options=Object.extend({caption:"",classname:"drag",constraint:null,ghosting:false,scroll:null,snap:null,threshold:0,onDrag:null,onEnd:null,onStart:null},arguments[1]||{});this.mousedownE=this._mouseDown.bindAsEventListener(this);this.element.observe("mousedown",this.mousedownE);if(this.options.scroll){this.options.scroll=$(this.options.scroll)}DragDrop.Drags.register(this);if(Prototype.Browser.IE){this.element.observe("selectstart",Event.stop)}else{if(Prototype.Browser.Gecko){this.element.setStyle({MozUserSelect:"none"})}}},destroy:function(){this.element.stopObserving("mousedown",this.mousedownE);DragDrop.Drags.unregister(this)},_mouseDown:function(A){$(document.body).setStyle({cursor:"default"});DragDrop.Drags.activate(this);this.move=0;this.wasDragged=false;this.lastcaption=null;if(Object.isFunction(this.options.onStart)){this.options.onStart(this,A)}if(!Prototype.Browser.IE&&!Prototype.Browser.Gecko){A.stop()}},_mouseMove:function(E){var B,C,A,D;if(++this.move<=this.options.threshold){return}this.lastCoord=D=[E.pointerX(),E.pointerY()];if(this.options.ghosting){if(!this.ghost){B=this.element.offsetLeft;C=this.element.offsetTop;this.ghost=$(this.element.cloneNode(true)).writeAttribute("id",null).setOpacity(0.7).clonePosition(this.element,{setLeft:false,setTop:false}).setStyle({left:B+"px",position:"absolute",top:C+"px",zIndex:parseInt(this.element.getStyle("zIndex"))+1});this.element.insert({before:this.ghost});A=this.ghost.viewportOffset();this.ghostOffset=[A[0]-B,A[1]-C]}D[0]-=this.ghostOffset[0];D[1]-=this.ghostOffset[1];switch(this.options.constraint){case"horizontal":D[1]=this.ghost.offsetTop;break;case"vertical":D[0]=this.ghost.offsetLeft;break}if(this.options.snap){D=this.options.snap(D[0],D[1],this.element)}if(this.options.offset){D[0]+=this.options.offset.x;D[1]+=this.options.offset.y}this._setContents(this.ghost,D[0],D[1])}this._onMoveDrag(D,E);if(Object.isFunction(this.options.onDrag)){this.options.onDrag(this,E)}this.wasDragged=true;if(this.options.scroll){this._onMoveScroll()}},_mouseUp:function(A){var B=DragDrop.Drops.drop;this._stopScrolling();if(this.ghost){this.ghost.remove();this.ghost=null}DragDrop.Drags.div.hide();if(DragDrop.validDrop(this.element)&&Object.isFunction(B.options.onDrop)){B.options.onDrop(B.element,this.element,A)}DragDrop.Drags.deactivate();if(Object.isFunction(this.options.onEnd)){this.options.onEnd(this,A)}},_onMoveDrag:function(I,E){var G,H,D,C,F=DragDrop.Drops.drop,A=DragDrop.Drags.div,B=true;if(F&&DragDrop.validDrop(this.element)){C=F.options.caption;if(C){H=Object.isFunction(C)?C(F.element,this.element,E):C;if(H&&F.options.hoverclass){D=F.options.hoverclass}}else{B=false}}if(B){if(!H){G=this.options.caption;H=Object.isFunction(G)?G(this.element):G}if(H!=this.lastcaption){this.lastcaption=H;A.update(H).writeAttribute({className:D||this.options.classname});if(H.empty()){A.hide()}}}if(!this.lastcaption.empty()){this._setContents(A,I[0]+15,I[1]+(this.ghost?(this.ghost.getHeight()+5):5))}},_onMoveScroll:function(){this._stopScrolling();var E,D,B,A=this.options.scroll,C=A.getDimensions();if(A.scrollHeight==C.height){return}E=document.viewport.getScrollOffsets();D=A.viewportOffset(),B=[0,0];D[0]+=A.scrollLeft+E.left;D[2]=D[0]+C.width;if(this.lastCoord[0]>D[2]||this.lastCoord[0]<D[0]){return}D[1]+=A.scrollTop+E.top;D[3]=D[1]+C.height;if(this.lastCoord[1]<D[1]){B[1]=this.lastCoord[1]-D[1]}if(this.lastCoord[1]>D[3]){B[1]=this.lastCoord[1]-D[3]}if(B[0]||B[1]){this.lastScrolled=new Date();this.scrollInterval=setInterval(this._scroll.bind(this,B[0]*15,B[1]*15),10)}},_stopScrolling:function(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=null}},_scroll:function(A,E){var C=new Date(),D=C-this.lastScrolled,B=this.options.scroll;this.lastScrolled=C;B.scrollTop+=E*D/1000},_setContents:function(C,A,E){var D=document.viewport.getDimensions(),B=C.getDimensions();if((A+B.width>D.width)||(E+B.height>D.height)){C.hide()}else{C.setStyle({left:A+"px",top:E+"px"}).show()}}}),Drop=Class.create({initialize:function(A){this.element=$(A);this.options=Object.extend({accept:[],caption:"",hoverclass:"",onDrop:null,onOut:null,onOver:null},arguments[1]||{});this.mouseoverE=this._mouseOver.bindAsEventListener(this);this.mouseoutE=this._mouseOut.bindAsEventListener(this);this.element.observe("mouseover",this.mouseoverE);this.element.observe("mouseout",this.mouseoutE);DragDrop.Drops.register(this)},destroy:function(){this.element.stopObserving("mouseover",this.mouseoverE);this.element.stopObserving("mouseout",this.mouseoutE);DragDrop.Drops.unregister(this)},_mouseOver:function(A){if(DragDrop.Drags.drag){DragDrop.Drops.drop=this;if(Object.isFunction(this.options.onOver)){this.options.onOver(this.element,DragDrop.Drags.drag)}}},_mouseOut:function(A){if(Object.isFunction(this.options.onOut)){this.options.onOut(this.element,DragDrop.Drags.drag)}DragDrop.Drops.drop=null}});