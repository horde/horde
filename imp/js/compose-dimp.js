var DimpCompose={last_msg:"",textarea_ready:true,confirmCancel:function(){if(window.confirm(DIMP.text_compose.cancel)){if(DIMP.conf_compose.auto_save_interval_val){DimpCore.doAction("DeleteDraft",{index:$F("index")})}return this._closeCompose()}},_closeCompose:function(){if(DIMP.conf_compose.qreply){this.closeQReply()}else{if(DIMP.baseWindow||DIMP.conf_compose.popup){DimpCore.closePopup()}else{DimpCore.redirect(DIMP.conf.URI_DIMP_INBOX)}}},closeQReply:function(){var A=$("attach_list").childElements();this.last_msg="";if(A.size()){this.removeAttach(A)}$("draft_index","composeCache").invoke("setValue","");$("qreply","sendcc","sendbcc").invoke("hide");[$("msgData"),$("togglecc").up(),$("togglebcc").up()].invoke("show");if(this.editor_on){this.toggleHtmlEditor()}$("compose").reset();if(this.auto_save_interval){this.auto_save_interval.stop()}},change_identity:function(){var E,B,G,F,A=$F("identity"),I=this.get_identity($F("last_identity")),H=$("message"),D=this.get_identity(A),C=$("save_sent_mail");$("sent_mail_folder_label").setText(D.id[5]);$("bcc").setValue(D.id[6]);if(C){C.writeAttribute("checked",D.id[4])}if(this.editor_on){B=FCKeditorAPI.GetInstance("message").GetHTML().replace(/\r\n/g,"\n");E="<p><!--begin_signature--><!--end_signature--></p>";G="<p><!--begin_signature-->"+D.sig.replace(/^ ?<br \/>\n/,"").replace(/ +/g," ")+"<!--end_signature--></p>";B=B.replace(/<p>\s*<!--begin_signature-->[\s\S]*?<!--end_signature-->\s*<\/p>/,E)}else{B=$F(H).replace(/\r\n/g,"\n");E=I.sig;G=D.sig}F=(I.id[2])?B.indexOf(E):B.lastIndexOf(E);if(F!=-1){if(D.id[2]==I.id[2]){B=B.substring(0,F)+G+B.substring(F+E.length,B.length)}else{if(D.id[2]){B=G+B.substring(0,F)+B.substring(F+E.length,B.length)}else{B=B.substring(0,F)+B.substring(F+E.length,B.length)+G}}B=B.replace(/\r\n/g,"\n").replace(/\n/g,"\r\n");if(this.editor_on){FCKeditorAPI.GetInstance("message").SetHTML(B)}else{H.setValue(B)}$("last_identity").setValue(A)}},get_identity:function(B,A){A=Object.isUndefined(A)?this.editor_on:A;return{id:DIMP.conf_compose.identities[B],sig:DIMP.conf_compose.identities[B][(A?1:0)].replace(/^\n/,"")}},uniqueSubmit:function(B){var A,C,E,D=$("compose");if(DIMP.SpellCheckerObject){DIMP.SpellCheckerObject.resume();if(!this.textarea_ready){this.uniqueSubmit.bind(this,B).defer();return}}D.setStyle({cursor:"wait"});if(B=="send_message"||B=="save_draft"){this.button_pressed=true;switch(B){case"send_message":if(!this.sbtext){E=$("send_button");this.sbtext=E.getText();E.setText(DIMP.text_compose.sending)}break;case"save_draft":if(!this.dbtext){A=$("draft_button");this.dbtext=A.getText();A.setText(DIMP.text_compose.saving)}break}if(this.uploading){(function(){if(this.button_pressed){this.uniqueSubmit(B)}}).bind(this).delay(0.25);return}}$("action").setValue(B);if(B=="add_attachment"){this.uploading=true;D.submit()}else{if(this.editor_on){FCKeditorAPI.GetInstance("message").UpdateLinkedField()}C=D.serialize(true);if(!DIMP.baseWindow){C.nonotify=true}DimpCore.doAction("*"+DIMP.conf.compose_url,C,null,this.uniqueSubmitCallback.bind(this))}},uniqueSubmitCallback:function(B){var A,C=B.response;if(!C){return}if(C.imp_compose){$("composeCache").setValue(C.imp_compose)}if(C.success||C.action=="add_attachment"){switch(C.action){case"auto_save_draft":this.button_pressed=false;$("draft_index").setValue(C.draft_index);break;case"save_draft":this.button_pressed=false;if(DIMP.baseWindow){DIMP.baseWindow.DimpBase.pollFolders();DIMP.baseWindow.DimpCore.showNotifications(B.msgs)}if(DIMP.conf_compose.close_draft){return this._closeCompose()}break;case"send_message":this.button_pressed=false;if(DIMP.baseWindow){if(C.reply_type=="reply"){DIMP.baseWindow.DimpBase.flag("answered",C.index,C.reply_folder)}if(C.folder){DIMP.baseWindow.DimpBase.createFolder(C.folder)}if(C.draft_delete){DIMP.baseWindow.DimpBase.pollFolders()}DIMP.baseWindow.DimpCore.showNotifications(B.msgs)}return this._closeCompose();case"add_attachment":this.uploading=false;if(C.success){this.addAttach(C.info.number,C.info.name,C.info.type,C.info.size)}else{this.button_pressed=false}if(DIMP.conf_compose.attach_limit!=-1&&$("attach_list").childElements().size()>DIMP.conf_compose.attach_limit){$("upload").writeAttribute("disabled",false);A=new Element("DIV",[DIMP.text_compose.attachment_limit])}else{A=new Element("INPUT",{type:"file",name:"file_1"});A.observe("change",this.uploadAttachment.bind(this))}$("upload_wait").replace(A.writeAttribute("id","upload"));this.resizeMsgArea();break}}else{this.button_pressed=false}$("compose").setStyle({cursor:null});if(!this.button_pressed){if(this.sbtext){$("send_button").setText(this.sbtext)}if(this.dbtext){$("draft_button").setText(this.dbtext)}this.dbtext=this.sbtext=null}DimpCore.showNotifications(B.msgs)},toggleHtmlEditor:function(A){if(!DIMP.conf_compose.rte_avail){return}A=A||false;if(DIMP.SpellCheckerObject){DIMP.SpellCheckerObject.resume()}var C;if(this.editor_on){this.editor_on=false;C=FCKeditorAPI.GetInstance("message").GetHTML();$("messageParent").childElements().invoke("hide");$("message").show();DimpCore.doAction("Html2Text",{text:C},null,this.setMessageText.bind(this),{asynchronous:false})}else{this.editor_on=true;if(!A){DimpCore.doAction("Text2Html",{text:$F("message")},null,this.setMessageText.bind(this),{asynchronous:false})}oFCKeditor.Height=this.getMsgAreaHeight();try{FCKeditorAPI.GetInstance("message").SetHTML($F("message"));$("messageParent").childElements().invoke("show");$("message").hide()}catch(B){this._RTELoading("show");FCKeditor_OnComplete=this._RTELoading.curry("hide");oFCKeditor.ReplaceTextarea()}}$("htmlcheckbox").checked=this.editor_on;$("html").setValue(this.editor_on?1:0)},_RTELoading:function(B){var C,A;if(!$("rteloading")){A=new Element("DIV",{id:"rteloading"}).clonePosition($("messageParent"));$(document.body).insert(A);C=A.viewportOffset();$(document.body).insert(new Element("SPAN",{id:"rteloadingtxt"}).setStyle({top:(C.top+15)+"px",left:(C.left+15)+"px"}).insert(DIMP.text.loading))}$("rteloading","rteloadingtxt").invoke(B)},toggleHtmlCheckbox:function(){if(!this.editor_on||window.confirm(DIMP.text_compose.toggle_html)){this.toggleHtmlEditor()}},getMsgAreaHeight:function(){return document.viewport.getHeight()-$("messageParent").cumulativeOffset()[1]-this.mp_padding},initializeSpellChecker:function(){if(!DIMP.conf_compose.rte_avail){return}if(typeof DIMP.SpellCheckerObject!="object"){this.initializeSpellChecker.bind(this).defer();return}DIMP.SpellCheckerObject.onBeforeSpellCheck=function(){if(!this.editor_on){return}DIMP.SpellCheckerObject.htmlAreaParent="messageParent";DIMP.SpellCheckerObject.htmlArea=$("message").adjacent("iframe[id*=message]").first();$("message").setValue(FCKeditorAPI.GetInstance("message").GetHTML());this.textarea_ready=false}.bind(this);DIMP.SpellCheckerObject.onAfterSpellCheck=function(){if(!this.editor_on){return}DIMP.SpellCheckerObject.htmlArea=DIMP.SpellCheckerObject.htmlAreaParent=null;var A=FCKeditorAPI.GetInstance("message");A.SetHTML($F("message"));A.Events.AttachEvent("OnAfterSetHTML",function(){this.textarea_ready=true}.bind(this))}.bind(this)},setMessageText:function(B){var A=$("message");if(!A){$("messageParent").insert(new Element("TEXTAREA",{id:"message",name:"message",style:"width:100%;"}).insert(B.response.text))}else{A.setValue(B.response.text)}if(!this.editor_on){this.resizeMsgArea()}},fillForm:function(G,H,B,E){if(!this.resizeto){this.fillForm.bind(this,G,H,B,E).defer();return}var A,D,C=this.get_identity($F("last_identity")),F=$("message");if(!this.last_msg.empty()&&this.last_msg!=$F(F).replace(/\r/g,"")&&!window.confirm(DIMP.text_compose.fillform)){return}if(DIMP.conf_compose.auto_save_interval_val&&!this.auto_save_interval){this.auto_save_interval=new PeriodicalExecuter(function(){var I;if(this.editor_on){I=FCKeditorAPI.GetInstance("message").GetHTML()}else{I=$F(F)}I=I.replace(/\r/g,"");if(!I.empty()&&this.last_msg!=I){this.uniqueSubmit("auto_save_draft");this.last_msg=I}}.bind(this),DIMP.conf_compose.auto_save_interval_val*60)}if(this.editor_on){D=FCKeditorAPI.GetInstance("message");D.SetHTML(G);this.last_msg=D.GetHTML().replace(/\r/g,"")}else{F.setValue(G);this.setCursorPosition(F);this.last_msg=$F(F).replace(/\r/g,"")}$("to").setValue(H.to);this.resizeto.resizeNeeded();if(H.cc){$("cc").setValue(H.cc);this.resizecc.resizeNeeded()}if(DIMP.conf_compose.cc){this.toggleCC("cc")}if(H.bcc){$("bcc").setValue(H.bcc);this.resizebcc.resizeNeeded()}if(C.id[6]){A=$F("bcc");if(A){A+=", "}$("bcc").setValue(A+C.id[6])}if(DIMP.conf_compose.bcc){this.toggleCC("bcc")}$("subject").setValue(H.subject);$("in_reply_to").setValue(H.in_reply_to);$("references").setValue(H.references);$("reply_type").setValue(H.replytype);Field.focus(B||"to");this.resizeMsgArea();if(DIMP.conf_compose.show_editor){if(!this.editor_on){this.toggleHtmlEditor(E||false)}if(B=="message"){this.focusEditor()}}},focusEditor:function(){try{FCKeditorAPI.GetInstance("message").Focus()}catch(A){this.focusEditor.bind(this).defer()}},addAttach:function(E,B,D,C){var F=new Element("DIV").insert(B+" ["+D+"] ("+C+" KB) "),A=new Element("INPUT",{type:"button",atc_id:E,value:DIMP.text_compose.remove});F.insert(A);$("attach_list").insert(F);A.observe("click",this.removeAttach.bind(this,[A.up()]));this.resizeMsgArea()},removeAttach:function(B){var A=[];B.each(function(C){C=$(C);A.push(C.firstDescendant().readAttribute("atc_id"));C.remove()});DimpCore.doAction("DeleteAttach",{atc_indices:A,imp_compose:$F("composeCache")});this.resizeMsgArea()},resizeMsgArea:function(){var A,B,D=document.documentElement,C=$("message");if(!DimpCore.window_load){this.resizeMsgArea.bind(this).defer();return}if(this.editor_on){A=$("messageParent").select("iframe").last();if(A){A.setStyle({height:this.getMsgAreaHeight()+"px"})}else{this.resizeMsgArea.bind(this).defer()}return}this.mp_padding=$("messageParent").getHeight()-C.getHeight();if(!this.row_height){A=$(C.cloneNode(false)).writeAttribute({id:null,name:null}).setStyle({visibility:"hidden"});$(document.body).insert(A);A.writeAttribute("rows",1);this.row_height=A.getHeight();A.writeAttribute("rows",2);this.row_height=A.getHeight()-this.row_height;A.remove()}B=parseInt(this.getMsgAreaHeight()/this.row_height);C.writeAttribute({rows:B,disabled:false});if(D.scrollHeight-D.clientHeight){C.writeAttribute({rows:B-1})}$("composeloading").hide()},uploadAttachment:function(){var A=$("upload");$("submit_frame").observe("load",this.attachmentComplete.bind(this));this.uniqueSubmit("add_attachment");A.stopObserving("change").replace(new Element("DIV",{id:"upload_wait"}).insert(DIMP.text_compose.uploading+" "+$F(A)))},attachmentComplete:function(){var A=$("submit_frame"),B=A.contentDocument||A.contentWindow.document;A.stopObserving("load");DimpCore.doActionComplete({responseText:B.body.innerHTML},this.uniqueSubmitCallback.bind(this))},toggleCC:function(A){$("send"+A).show();$("toggle"+A).up().hide()},setCursorPosition:function(B){var C,A;switch(DIMP.conf_compose.compose_cursor){case"top":C=0;$("message").setValue("\n"+$F("message"));break;case"bottom":C=$F("message").length;break;case"sig":C=$F("message").replace(/\r\n/g,"\n").lastIndexOf(this.get_identity($F("last_identity")).sig)-1;break;default:return}if(B.setSelectionRange){Field.focus(B);B.setSelectionRange(C,C)}else{if(B.createTextRange){A=B.createTextRange();A.collapse(true);A.moveStart("character",C);A.moveEnd("character",0);Field.select(A);A.scrollIntoView(true)}}},openAddressbook:function(){window.open(DIMP.conf_compose.abook_url,"contacts","toolbar=no,location=no,status=no,scrollbars=yes,resizable=yes,width=550,height=300,left=100,top=100")}},ResizeTextArea=Class.create({maxRows:5,initialize:function(C,B){this.field=$(C);this.defaultRows=Math.max(this.field.readAttribute("rows"),1);this.onResize=B;var A=this.resizeNeeded.bindAsEventListener(this);this.field.observe("mousedown",A).observe("keyup",A);this.resizeNeeded()},resizeNeeded:function(){var A=$F(this.field).split("\n"),C=this.field.readAttribute("cols"),B=A.size(),D=this.field.readAttribute("rows");A.each(function(E){if(E.length>=C){B+=Math.floor(E.length/C)}});if(B!=D){this.field.writeAttribute("rows",(B>D)?Math.min(B,this.maxRows):Math.max(this.defaultRows,B));if(this.onResize){this.onResize()}}}});document.observe("dom:loaded",function(){var B,A=DimpCompose,D=A.resizeMsgArea.bind(A),E=DimpCore.clickObserveHandler;A.resizeMsgArea();A.initializeSpellChecker();$("upload").observe("change",A.uploadAttachment.bind(A));A.resizeto=new ResizeTextArea("to",D);A.resizecc=new ResizeTextArea("cc",D);A.resizebcc=new ResizeTextArea("bcc",D);if(Prototype.Browser.WebKit){$("submit_frame").writeAttribute({position:"absolute",width:"1px",height:"1px"}).setStyle({left:"-999px"}).show()}if(B=$("compose_close")){E({d:B,f:A.confirmCancel.bind(A)})}E({d:$("send_button"),f:A.uniqueSubmit.bind(A,"send_message")});E({d:$("draft_button"),f:A.uniqueSubmit.bind(A,"save_draft")});["cc","bcc"].each(function(C){E({d:$("toggle"+C),f:A.toggleCC.bind(A,C)})});if(B=$("htmlcheckbox")){E({d:B,f:A.toggleHtmlCheckbox.bind(A),ns:true})}if(B=$("compose_specialchars")){E({d:B,f:function(){window.open(DIMP.conf_compose.specialchars_url,"chars","height=220,width=400")}})}$("writemsg").select(".composeAddrbook").each(function(C){E({d:C,f:A.openAddressbook.bind(A)})});$("compose").observe("submit",Event.stop);$("identity").observe("change",A.change_identity.bind(A));$("togglecc").observe("click",D);$("togglebcc").observe("click",D);Event.observe(window,"resize",D)});