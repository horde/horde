var SpellChecker=Class.create({options:{},resumeOnDblClick:true,state:"CheckSpelling",initialize:function(a,f,c,j,b,h){var g,i,e;this.url=a;this.target=f;this.statusButton=$(c);this.buttonStates=j;this.statusClass=h||"";this.statusButton.observe("click",this.process.bindAsEventListener(this));this.options.onComplete=this.onComplete.bind(this);if(b){g=new Element("DIV",{className:"autocomplete",id:"spellcheckpopdown"}).setStyle({position:"absolute"}).hide();e=new Element("UL");$H(b).each(function(d){e.insert({bottom:new Element("LI",{lc:d.key}).update(d.value)})});g.insert({bottom:e});this.localeChoices=new KeyNavList(g,{onChoose:this.setLocale.bindAsEventListener(this)});i=new Element("SPAN",{className:"spellcheckPopdownImg"}).observe("click",function(){$("spellcheckpopdown").clonePosition(this.statusButton,{setHeight:false,setWidth:false,offsetTop:this.statusButton.getHeight()});this.localeChoices.show()}.bind(this));this.statusButton.insert({after:i});$(document.body).insert(g)}document.observe("click",this.onClick.bindAsEventListener(this));this.status("CheckSpelling")},setLocale:function(a){this.locale=a.readAttribute("lc")},targetValue:function(){var a=$(this.target);return(Object.isUndefined(a.value))?a.innerHTML:a.value},process:function(a){switch(this.state){case"CheckSpelling":this.spellCheck();break;case"ResumeEdit":this.resume();break}a.stop()},spellCheck:function(){if(this.onBeforeSpellCheck){this.onBeforeSpellCheck()}var b=Object.clone(this.options),c=$H(),a=this.url;this.status("Checking");this.removeChoices();c.set(this.target,this.targetValue());b.parameters=c.toQueryString();if(this.locale){a+="/locale="+this.locale}if(this.htmlAreaParent){a+="/html=1"}new Ajax.Request(a,b)},onClick:function(b){if(this.localeChoices){this.localeChoices.hide()}if(!this.choicesDiv){return true}var a=b.findElement("SPAN");if(a&&a==this.curWord){return true}this.removeChoices();this.curWord=null},onComplete:function(b){var a,f,g,j,e,c=0,h=$(this.target),k=b.responseJSON;this.removeChoices();if(Object.isUndefined(k)){this.resume();this.status("Error");return}a=k.bad||[];this.suggestions=k.suggestions||[];f=this.targetValue();if(this.htmlAreaParent){f=f.replace(/\r?\n/g,"")}else{f=f.replace(/\r?\n/g,"~~~").escapeHTML()}$A(a).each(function(d){j=new RegExp("(?:^|\\b)"+RegExp.escape(d)+"(?:\\b|$)","g");e='<span index="'+(c++)+'" name="incorrect" class="incorrect">'+d+"</span>";f=f.replace(j,e);if(this.htmlAreaParent){f=f.replace(new RegExp("(<[^>]*)"+RegExp.escape(e)+"([^>]*>)","g"),"$1"+d+"$2")}},this);if(!this.reviewDiv){this.reviewDiv=new Element("div",{className:h.readAttribute("className")+" spellcheck"}).setStyle({overflow:"auto"});if(this.resumeOnDblClick){this.reviewDiv.observe("dblclick",this.resume.bind(this))}}g=h.getDimensions();this.reviewDiv.setStyle({width:g.width+"px",height:g.height+"px"});if(!this.htmlAreaParent){f=f.replace(/~~~/g,"<br />")}this.reviewDiv.update(f);this.reviewDiv.select('span[name="incorrect"]').invoke("observe","click",this.showSuggestions.bindAsEventListener(this));this.reviewDiv.select("A").invoke("observe","click",Event.stop);if(this.htmlAreaParent){Element.hide(this.htmlArea);$(this.htmlAreaParent).insert({bottom:this.reviewDiv})}else{h.hide().insert({before:this.reviewDiv})}this.status("ResumeEdit")},showSuggestions:function(d){var f,a=d.element(),b=new Element("UL");try{f=a.viewportOffset()}catch(c){f=[d.pointerX(),d.pointerY()]}this.removeChoices();this.choicesDiv=new Element("DIV",{className:"autocomplete"}).setStyle({left:f[0]+"px",top:(f[1]+16)+"px"}).hide();this.curWord=a;$A(this.suggestions[this.curWord.readAttribute("index")]).each(function(e){b.insert({bottom:new Element("LI").update(e)})});this.choicesDiv.insert({bottom:b});this.choices=new KeyNavList(this.choicesDiv,{onChoose:function(e){this.replaceWord(e,this.curWord)}.bind(this)}).show();$(document.body).insert(this.choicesDiv)},replaceWord:function(a,b){b.update(a.innerHTML).writeAttribute({className:"corrected"});this.removeChoices()},removeChoices:function(){if(this.choicesDiv){this.choicesDiv.remove();this.choicesDiv=null}},resume:function(){this.removeChoices();if(!this.reviewDiv){return}var a=$(this.target),b;this.reviewDiv.select('span[name="incorrect"]').each(function(c){c.replace(c.innerHTML)});this.reviewDiv.select("A").invoke("stopObserving","click");b=this.reviewDiv.innerHTML;if(!this.htmlAreaParent){b=b.replace(/<br *\/?>/gi,"~~~").unescapeHTML().replace(/~~~/g,"\n")}a.value=b;a.disabled=false;if(this.resumeOnDblClick){this.reviewDiv.stopObserving("dblclick")}this.reviewDiv.remove();this.reviewDiv=null;this.status("CheckSpelling");if(this.htmlAreaParent){Element.show(this.htmlArea)}else{a.show()}if(this.onAfterSpellCheck){this.onAfterSpellCheck()}},status:function(a){if(!this.statusButton){return}this.state=a;switch(this.statusButton.tagName){case"INPUT":this.statusButton.value=this.buttonStates[a];break;case"A":this.statusButton.update(this.buttonStates[a]);break}this.statusButton.className=this.statusClass+" "+a},isActive:function(){return(this.reviewDiv)}});