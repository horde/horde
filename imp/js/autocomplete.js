var Autocompleter={};Autocompleter.Base=Class.create({baseInitialize:function(b,c,a){this.element=$(b);this.update=$(c).hide();this.active=this.changed=this.hasFocus=false;this.entryCount=this.index=0;this.observer=null;this.oldval=$F(this.element);this.options=Object.extend({paramName:this.element.name,tokens:[],frequency:0.4,minChars:1,onHide:this._onHide.bind(this),onShow:this._onShow.bind(this)},(this._setOptions?this._setOptions(a):(a||{})));if(!this.options.tokens.include("\n")){this.options.tokens.push("\n")}this.element.writeAttribute("autocomplete","off").observe("blur",this._onBlur.bindAsEventListener(this)).observe(Prototype.Browser.Gecko?"keypress":"keydown",this._onKeyPress.bindAsEventListener(this))},_onShow:function(a,e){var d,b=e.getStyle("position");if(!b||b=="absolute"){d=(Prototype.Browser.IE)?a.cumulativeScrollOffset():[0];e.setStyle({position:"absolute"}).clonePosition(a,{setHeight:false,offsetTop:a.offsetHeight,offsetLeft:d[0]})}new Effect.Appear(e,{duration:0.15})},_onHide:function(a,b){new Effect.Fade(b,{duration:0.15})},show:function(){if(!this.update.visible()){this.options.onShow(this.element,this.update)}if(Prototype.Browser.IE&&!this.iefix&&this.update.getStyle("position")=="absolute"){this.iefix=new Element("IFRAME",{src:"javascript:false;",frameborder:0,scrolling:"no"}).setStyle({position:"absolute",filter:"progid:DXImageTransform.Microsoft.Alpha(opactiy=0)",zIndex:1}).hide();this.update.setStyle({zIndex:2}).insert({after:this.iefix})}if(this.iefix){this._fixIEOverlapping.bind(this).delay(0.05)}},_fixIEOverlapping:function(){this.iefix.clonePosition(this.update).show()},hide:function(){this.stopIndicator();if(this.update.visible()){this.options.onHide(this.element,this.update);if(this.iefix){this.iefix.hide()}}},startIndicator:function(){if(this.options.indicator){$(this.options.indicator).show()}},stopIndicator:function(){if(this.options.indicator){$(this.options.indicator).hide()}},_onKeyPress:function(a){if(this.active){switch(a.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.selectEntry();a.stop();return;case Event.KEY_ESC:this.hide();this.active=false;a.stop();return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:case Event.KEY_DOWN:if(a.keyCode==Event.KEY_UP){this.markPrevious()}else{this.markNext()}this.render();a.stop();return}}else{switch(a.keyCode){case 0:if(!Prototype.Browser.WebKit){break}case Event.KEY_TAB:case Event.KEY_RETURN:return}}this.changed=this.hasFocus=true;if(this.observer){clearTimeout(this.observer)}this.observer=this.onObserverEvent.bind(this).delay(this.options.frequency)},_onHover:function(c){var b=c.findElement("LI"),a=b.readAttribute("acIndex");if(this.index!=a){this.index=a;this.render()}c.stop()},_onClick:function(a){this.index=a.findElement("LI").readAttribute("acIndex");this.selectEntry()},_onBlur:function(a){this.hide.bind(this).delay(0.25);this.active=this.hasFocus=false},render:function(){var a=0;if(this.entryCount){this.update.down().childElements().each(function(b){[b].invoke(this.index==a++?"addClassName":"removeClassName","selected")},this);if(this.hasFocus){this.show();this.active=true}}else{this.active=false;this.hide()}},markPrevious:function(){if(this.index){--this.index}else{this.index=this.entryCount-1}this.getEntry(this.index).scrollIntoView(true)},markNext:function(){if(this.index<this.entryCount-1){++this.index}else{this.index=0}this.getEntry(this.index).scrollIntoView(false)},getEntry:function(a){return this.update.down().childElements()[a]},selectEntry:function(){this.active=false;this.updateElement(this.getEntry(this.index));this.hide()},updateElement:function(d){var e,g,b,c,a,h=this.options,f="";if(h.updateElement){h.updateElement(d);return}if(h.select){b=$(d).select("."+h.select)||[];if(b.size()){f=b[0].collectTextNodes(h.select)}}else{f=d.collectTextNodesIgnoreClass("informal")}e=this.getTokenBounds();if(e[0]!=-1){a=$F(this.element);g=a.substr(0,e[0]);c=a.substr(e[0]).match(/^\s+/);if(c){g+=c[0]}this.element.setValue(g+f+a.substr(e[1]))}else{this.element.setValue(f)}this.element.focus();if(h.afterUpdateElement){h.afterUpdateElement(this.element,d)}this.oldval=$F(this.element)},updateChoices:function(e){var a,d,c,b=0;if(!this.changed&&this.hasFocus){a=new Element("LI");c=new Element("UL");d=new RegExp("("+this.getToken()+")","i");e.each(function(f){c.insert(a.cloneNode(false).writeAttribute("acIndex",b++).update(f.gsub(d,"<strong>#{1}</strong>")))});this.update.update(c);this.entryCount=e.size();c.childElements().each(this.addObservers.bind(this));this.stopIndicator();this.index=0;if(this.entryCount==1&&this.options.autoSelect){this.selectEntry()}else{this.render()}}},addObservers:function(a){$(a).observe("mouseover",this._onHover.bindAsEventListener(this)).observe("click",this._onClick.bindAsEventListener(this))},onObserverEvent:function(){this.changed=false;if(this.getToken().length>=this.options.minChars){this.getUpdatedChoices()}else{this.active=false;this.hide()}this.oldval=$F(this.element)},getToken:function(){var a=this.getTokenBounds();return $F(this.element).substring(a[0],a[1]).strip()},getTokenBounds:function(){var j,e,f,c,d,g,m=this.options.tokens,k=$F(this.element),h=k.length,b=-1,a=Math.min(h,this.oldval.length);if(k.strip().empty()){return[-1,0]}j=a;for(e=0;e<a;++e){if(k[e]!=this.oldval[e]){j=e;break}}d=(j==this.oldval.length?1:0);for(f=0,c=m.length;f<c;++f){g=k.lastIndexOf(m[f],j+d-1);if(g>b){b=g}g=k.indexOf(m[f],j+d);if(g!=-1&&g<h){h=g}}return[b+1,h]}});Ajax.Autocompleter=Class.create(Autocompleter.Base,{initialize:function(c,d,b,a){this.baseInitialize(c,d,a);this.options=Object.extend(this.options,{asynchronous:true,onComplete:this._onComplete.bind(this),defaultParams:$H(this.options.parameters)});this.url=b;this.cache=$H()},getUpdatedChoices:function(){var b,d=this.options,a=this.getToken(),e=this.cache.get(a);if(e){this.updateChoices(e)}else{b=Object.clone(d.defaultParams);this.startIndicator();b.set(d.paramName,a);d.parameters=b.toQueryString();new Ajax.Request(this.url,d)}},_onComplete:function(a){this.updateChoices(this.cache.set(this.getToken(),a.responseJSON))}});Autocompleter.Local=Class.create(Autocompleter.Base,{initialize:function(c,d,a,b){this.baseInitialize(c,d,b);this.options.arr=a},getUpdatedChoices:function(){this.updateChoices(this._selector())},_setOptions:function(a){return Object.extend({choices:10,partialSearch:true,partialChars:2,ignoreCase:true,fullSearch:false},a||{})},_selector:function(){var b=this.getToken(),c=b.length,a=0,d=this.options;if(d.ignoreCase){b=b.toLowerCase()}return d.arr.findAll(function(e){if(a==d.choices){throw $break}if(d.ignoreCase){e=e.toLowerCase()}e=e.unescapeHTML();var f=e.indexOf(b);if(f!=-1&&((f==0&&e.length!=c)||(c>=d.partialChars&&d.partialSearch&&(d.fullSearch||/\s/.test(e.substr(f-1,1)))))){++a;return true}return false},this)}});