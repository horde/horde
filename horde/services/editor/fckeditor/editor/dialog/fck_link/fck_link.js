var dialog=window.parent;var oEditor=dialog.InnerDialogLoaded();var FCK=oEditor.FCK;var FCKLang=oEditor.FCKLang;var FCKConfig=oEditor.FCKConfig;var FCKRegexLib=oEditor.FCKRegexLib;var FCKTools=oEditor.FCKTools;dialog.AddTab("Info",FCKLang.DlgLnkInfoTab);if(!FCKConfig.LinkDlgHideTarget){dialog.AddTab("Target",FCKLang.DlgLnkTargetTab,true)}if(FCKConfig.LinkUpload){dialog.AddTab("Upload",FCKLang.DlgLnkUpload,true)}if(!FCKConfig.LinkDlgHideAdvanced){dialog.AddTab("Advanced",FCKLang.DlgAdvancedTag)}function OnDialogTabChange(a){ShowE("divInfo",(a=="Info"));ShowE("divTarget",(a=="Target"));ShowE("divUpload",(a=="Upload"));ShowE("divAttribs",(a=="Advanced"));dialog.SetAutoSize(true)}var oRegex=new Object();oRegex.UriProtocol=/^(((http|https|ftp|news):\/\/)|mailto:)/gi;oRegex.UrlOnChangeProtocol=/^(http|https|ftp|news):\/\/(?=.)/gi;oRegex.UrlOnChangeTestOther=/^((javascript:)|[#\/\.])/gi;oRegex.ReserveTarget=/^_(blank|self|top|parent)$/i;oRegex.PopupUri=/^javascript:void\(\s*window.open\(\s*'([^']+)'\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*\)\s*$/;oRegex.OnClickPopup=/^\s*on[cC]lick="\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*"$/;oRegex.PopupFeatures=/(?:^|,)([^=]+)=(\d+|yes|no)/gi;var oParser=new Object();oParser.SortNumerical=function(d,c){return parseInt(d,10)-parseInt(c,10)};oParser.ParseEMailParams=function(c){var a=new Object();a.Subject="";a.Body="";var b=c.match(/(^|^\?|&)subject=([^&]+)/i);if(b){a.Subject=decodeURIComponent(b[2])}b=c.match(/(^|^\?|&)body=([^&]+)/i);if(b){a.Body=decodeURIComponent(b[2])}return a};oParser.ParseEMailUri=function(sUrl){var oEMailInfo=new Object();oEMailInfo.Address="";oEMailInfo.Subject="";oEMailInfo.Body="";var aLinkInfo=sUrl.match(/^(\w+):(.*)$/);if(aLinkInfo&&aLinkInfo[1]=="mailto"){var aParts=aLinkInfo[2].match(/^([^\?]+)\??(.+)?/);if(aParts){oEMailInfo.Address=aParts[1];if(aParts[2]){var oEMailParams=oParser.ParseEMailParams(aParts[2]);oEMailInfo.Subject=oEMailParams.Subject;oEMailInfo.Body=oEMailParams.Body}}return oEMailInfo}else{if(aLinkInfo&&aLinkInfo[1]=="javascript"){var func=FCKConfig.EMailProtectionFunction;if(func!=null){try{func=func.replace(/([\/^$*+.?()\[\]])/g,"\\$1");var keys=new Array("NAME","DOMAIN","SUBJECT","BODY");var sFunc=func;var pos=new Array();for(var i=0;i<keys.length;i++){var rexp=new RegExp(keys[i]);var p=func.search(rexp);if(p>=0){sFunc=sFunc.replace(rexp,"'([^']*)'");pos[pos.length]=p+":"+keys[i]}}pos.sort(oParser.SortNumerical);aLinkInfo[2]=aLinkInfo[2].replace(/\\'/g,"###SINGLE_QUOTE###");var rFunc=new RegExp("^"+sFunc+"$");var aMatch=rFunc.exec(aLinkInfo[2]);if(aMatch){var aInfo=new Array();for(var i=1;i<aMatch.length;i++){var k=pos[i-1].match(/^\d+:(.+)$/);aInfo[k[1]]=aMatch[i].replace(/###SINGLE_QUOTE###/g,"'")}oEMailInfo.Address=aInfo.NAME+"@"+aInfo.DOMAIN;oEMailInfo.Subject=decodeURIComponent(aInfo.SUBJECT);oEMailInfo.Body=decodeURIComponent(aInfo.BODY);return oEMailInfo}}catch(e){}}var aMatch=aLinkInfo[2].match(/^(?:void\()?location\.href='mailto:'\+(String\.fromCharCode\([\d,]+\))\+'(.*)'\)?$/);if(aMatch){oEMailInfo.Address=eval(aMatch[1]);if(aMatch[2]){var oEMailParams=oParser.ParseEMailParams(aMatch[2]);oEMailInfo.Subject=oEMailParams.Subject;oEMailInfo.Body=oEMailParams.Body}return oEMailInfo}}}return false};oParser.CreateEMailUri=function(j,h,f){switch(FCKConfig.EMailProtection){case"function":var c=FCKConfig.EMailProtectionFunction;if(c==null){if(FCKConfig.Debug){alert('EMailProtection alert!\nNo function defined. Please set "FCKConfig.EMailProtectionFunction"')}return""}var d=j.split("@",2);if(d[1]==undefined){d[1]=""}c=c.replace(/NAME/g,"'"+d[0].replace(/'/g,"\\'")+"'");c=c.replace(/DOMAIN/g,"'"+d[1].replace(/'/g,"\\'")+"'");c=c.replace(/SUBJECT/g,"'"+encodeURIComponent(h).replace(/'/g,"\\'")+"'");c=c.replace(/BODY/g,"'"+encodeURIComponent(f).replace(/'/g,"\\'")+"'");return"javascript:"+c;case"encode":var b=[];var a=[];if(h.length>0){b.push("subject="+encodeURIComponent(h))}if(f.length>0){b.push("body="+encodeURIComponent(f))}for(var e=0;e<j.length;e++){a.push(j.charCodeAt(e))}return"javascript:void(location.href='mailto:'+String.fromCharCode("+a.join(",")+")+'?"+b.join("&")+"')"}var g="mailto:"+j;var k="";if(h.length>0){k="?subject="+encodeURIComponent(h)}if(f.length>0){k+=(k.length==0?"?":"&");k+="body="+encodeURIComponent(f)}return g+k};var oLink=dialog.Selection.GetSelection().MoveToAncestorNode("A");if(oLink){FCK.Selection.SelectNode(oLink)}window.onload=function(){oEditor.FCKLanguageManager.TranslatePage(document);LoadAnchorNamesAndIds();LoadSelection();SetLinkType(GetE("cmbLinkType").value);GetE("divBrowseServer").style.display=FCKConfig.LinkBrowser?"":"none";GetE("divInfo").style.display="";if(FCKConfig.LinkUpload){GetE("frmUpload").action=FCKConfig.LinkUploadURL}SetDefaultTarget();dialog.SetOkButton(true);switch(GetE("cmbLinkType").value){case"url":SelectField("txtUrl");break;case"email":SelectField("txtEMailAddress");break;case"anchor":if(GetE("divSelAnchor").style.display!="none"){SelectField("cmbAnchorName")}else{SelectField("cmbLinkType")}}};var bHasAnchors;function LoadAnchorNamesAndIds(){var a=new Array();var c;var b=oEditor.FCK.EditorDocument.getElementsByTagName("IMG");for(c=0;c<b.length;c++){if(b[c].getAttribute("_fckanchor")){a[a.length]=oEditor.FCK.GetRealElement(b[c])}}var f=oEditor.FCK.EditorDocument.getElementsByTagName("A");for(c=0;c<f.length;c++){if(f[c].name&&(f[c].name.length>0)){a[a.length]=f[c]}}var d=FCKTools.GetAllChildrenIds(oEditor.FCK.EditorDocument.body);bHasAnchors=(a.length>0||d.length>0);for(c=0;c<a.length;c++){var e=a[c].name;if(e&&e.length>0){FCKTools.AddSelectOption(GetE("cmbAnchorName"),e,e)}}for(c=0;c<d.length;c++){FCKTools.AddSelectOption(GetE("cmbAnchorId"),d[c],d[c])}ShowE("divSelAnchor",bHasAnchors);ShowE("divNoAnchor",!bHasAnchors)}function LoadSelection(){if(!oLink){return}var a="url";var f=oLink.getAttribute("_fcksavedurl");if(f==null){f=oLink.getAttribute("href",2)||""}var h=oRegex.PopupUri.exec(f);if(h){GetE("cmbTarget").value="popup";f=h[1];FillPopupFields(h[2],h[3]);SetTarget("popup")}if(!h){var i=oLink.getAttribute("onclick_fckprotectedatt");if(i){i=decodeURIComponent(i);h=oRegex.OnClickPopup.exec(i);if(h){GetE("cmbTarget").value="popup";FillPopupFields(h[1],h[2]);SetTarget("popup")}}}var e=oRegex.UriProtocol.exec(f);var g=oParser.ParseEMailUri(f);if(g){a="email";GetE("txtEMailAddress").value=g.Address;GetE("txtEMailSubject").value=g.Subject;GetE("txtEMailBody").value=g.Body}else{if(e){e=e[0].toLowerCase();GetE("cmbLinkProtocol").value=e;var b=f.replace(oRegex.UriProtocol,"");a="url";GetE("txtUrl").value=b}else{if(f.substr(0,1)=="#"&&f.length>1){a="anchor";GetE("cmbAnchorName").value=GetE("cmbAnchorId").value=f.substr(1)}else{a="url";GetE("cmbLinkProtocol").value="";GetE("txtUrl").value=f}}}if(!h){var c=oLink.target;if(c&&c.length>0){if(oRegex.ReserveTarget.test(c)){c=c.toLowerCase();GetE("cmbTarget").value=c}else{GetE("cmbTarget").value="frame"}GetE("txtTargetFrame").value=c}}GetE("txtAttId").value=oLink.id;GetE("txtAttName").value=oLink.name;GetE("cmbAttLangDir").value=oLink.dir;GetE("txtAttLangCode").value=oLink.lang;GetE("txtAttAccessKey").value=oLink.accessKey;GetE("txtAttTabIndex").value=oLink.tabIndex<=0?"":oLink.tabIndex;GetE("txtAttTitle").value=oLink.title;GetE("txtAttContentType").value=oLink.type;GetE("txtAttCharSet").value=oLink.charset;var d;if(oEditor.FCKBrowserInfo.IsIE){d=oLink.getAttribute("className",2)||"";d=d.replace(FCKRegexLib.FCK_Class,"");GetE("txtAttStyle").value=oLink.style.cssText}else{d=oLink.getAttribute("class",2)||"";GetE("txtAttStyle").value=oLink.getAttribute("style",2)||""}GetE("txtAttClasses").value=d;GetE("cmbLinkType").value=a}function SetLinkType(a){ShowE("divLinkTypeUrl",(a=="url"));ShowE("divLinkTypeAnchor",(a=="anchor"));ShowE("divLinkTypeEMail",(a=="email"));if(!FCKConfig.LinkDlgHideTarget){dialog.SetTabVisibility("Target",(a=="url"))}if(FCKConfig.LinkUpload){dialog.SetTabVisibility("Upload",(a=="url"))}if(!FCKConfig.LinkDlgHideAdvanced){dialog.SetTabVisibility("Advanced",(a!="anchor"||bHasAnchors))}if(a=="email"){dialog.SetAutoSize(true)}}function SetTarget(a){GetE("tdTargetFrame").style.display=(a=="popup"?"none":"");GetE("tdPopupName").style.display=GetE("tablePopupFeatures").style.display=(a=="popup"?"":"none");switch(a){case"_blank":case"_self":case"_parent":case"_top":GetE("txtTargetFrame").value=a;break;case"":GetE("txtTargetFrame").value="";break}if(a=="popup"){dialog.SetAutoSize(true)}}function OnUrlChange(){var a=GetE("txtUrl").value;var b=oRegex.UrlOnChangeProtocol.exec(a);if(b){a=a.substr(b[0].length);GetE("txtUrl").value=a;GetE("cmbLinkProtocol").value=b[0].toLowerCase()}else{if(oRegex.UrlOnChangeTestOther.test(a)){GetE("cmbLinkProtocol").value=""}}}function OnTargetNameChange(){var a=GetE("txtTargetFrame").value;if(a.length==0){GetE("cmbTarget").value=""}else{if(oRegex.ReserveTarget.test(a)){GetE("cmbTarget").value=a.toLowerCase()}else{GetE("cmbTarget").value="frame"}}}function BuildOnClickPopup(){var d="'"+GetE("txtPopupName").value.replace(/\W/gi,"")+"'";var c="";var b=document.getElementsByName("chkFeature");for(var a=0;a<b.length;a++){if(a>0){c+=","}c+=b[a].value+"="+(b[a].checked?"yes":"no")}if(GetE("txtPopupWidth").value.length>0){c+=",width="+GetE("txtPopupWidth").value}if(GetE("txtPopupHeight").value.length>0){c+=",height="+GetE("txtPopupHeight").value}if(GetE("txtPopupLeft").value.length>0){c+=",left="+GetE("txtPopupLeft").value}if(GetE("txtPopupTop").value.length>0){c+=",top="+GetE("txtPopupTop").value}if(c!=""){c=c+",status"}return("window.open(this.href,"+d+",'"+c+"'); return false")}function FillPopupFields(b,e){if(b){GetE("txtPopupName").value=b}var f=new Object();var a;while((a=oRegex.PopupFeatures.exec(e))!=null){var g=a[2];if(g==("yes"||"1")){f[a[1]]=true}else{if(!isNaN(g)&&g!=0){f[a[1]]=g}}}var d=document.getElementsByName("chkFeature");for(var c=0;c<d.length;c++){if(f[d[c].value]){d[c].checked=true}}if(f.width){GetE("txtPopupWidth").value=f.width}if(f.height){GetE("txtPopupHeight").value=f.height}if(f.left){GetE("txtPopupLeft").value=f.left}if(f.top){GetE("txtPopupTop").value=f.top}}function Ok(){var a,h;oEditor.FCKUndo.SaveUndoStep();switch(GetE("cmbLinkType").value){case"url":a=GetE("txtUrl").value;if(a.length==0){alert(FCKLang.DlnLnkMsgNoUrl);return false}a=GetE("cmbLinkProtocol").value+a;break;case"email":a=GetE("txtEMailAddress").value;if(a.length==0){alert(FCKLang.DlnLnkMsgNoEMail);return false}a=oParser.CreateEMailUri(a,GetE("txtEMailSubject").value,GetE("txtEMailBody").value);break;case"anchor":var k=GetE("cmbAnchorName").value;if(k.length==0){k=GetE("cmbAnchorId").value}if(k.length==0){alert(FCKLang.DlnLnkMsgNoAnchor);return false}a="#"+k;break}var f=oLink?[oLink]:oEditor.FCK.CreateLink(a,true);var c=(f.length>0);if(!c){h=a;switch(GetE("cmbLinkType").value){case"anchor":h=h.replace(/^#/,"");break;case"url":var e=new RegExp("//?([^?\"']+)([?].*)?$");var g=e.exec(a);if(g!=null){h=g[1]}break;case"email":h=GetE("txtEMailAddress").value;break}f=[oEditor.FCK.InsertElement("a")]}for(var d=0;d<f.length;d++){oLink=f[d];if(c){h=oLink.innerHTML}oLink.href=a;SetAttribute(oLink,"_fcksavedurl",a);var j;if(GetE("cmbTarget").value=="popup"){j=BuildOnClickPopup();j=encodeURIComponent(' onclick="'+j+'"');SetAttribute(oLink,"onclick_fckprotectedatt",j)}else{j=oLink.getAttribute("onclick_fckprotectedatt");if(j){j=decodeURIComponent(j);if(oRegex.OnClickPopup.test(j)){SetAttribute(oLink,"onclick_fckprotectedatt","")}}}oLink.innerHTML=h;if(GetE("cmbTarget").value!="popup"){SetAttribute(oLink,"target",GetE("txtTargetFrame").value)}else{SetAttribute(oLink,"target",null)}if(d==0){SetAttribute(oLink,"id",GetE("txtAttId").value)}SetAttribute(oLink,"name",GetE("txtAttName").value);SetAttribute(oLink,"dir",GetE("cmbAttLangDir").value);SetAttribute(oLink,"lang",GetE("txtAttLangCode").value);SetAttribute(oLink,"accesskey",GetE("txtAttAccessKey").value);SetAttribute(oLink,"tabindex",(GetE("txtAttTabIndex").value>0?GetE("txtAttTabIndex").value:null));SetAttribute(oLink,"title",GetE("txtAttTitle").value);SetAttribute(oLink,"type",GetE("txtAttContentType").value);SetAttribute(oLink,"charset",GetE("txtAttCharSet").value);if(oEditor.FCKBrowserInfo.IsIE){var b=GetE("txtAttClasses").value;if(GetE("txtAttName").value.length!=0){b+=" FCK__AnchorC"}SetAttribute(oLink,"className",b);oLink.style.cssText=GetE("txtAttStyle").value}else{SetAttribute(oLink,"class",GetE("txtAttClasses").value);SetAttribute(oLink,"style",GetE("txtAttStyle").value)}}oEditor.FCKSelection.SelectNode(f[0]);return true}function BrowseServer(){OpenFileBrowser(FCKConfig.LinkBrowserURL,FCKConfig.LinkBrowserWindowWidth,FCKConfig.LinkBrowserWindowHeight)}function SetUrl(a){GetE("txtUrl").value=a;OnUrlChange();dialog.SetSelectedTab("Info")}function OnUploadCompleted(c,a,d,b){window.parent.Throbber.Hide();GetE("divUpload").style.display="";switch(c){case 0:alert("Your file has been successfully uploaded");break;case 1:alert(b);return;case 101:alert(b);break;case 201:alert('A file with the same name is already available. The uploaded file has been renamed to "'+d+'"');break;case 202:alert("Invalid file type");return;case 203:alert("Security error. You probably don't have enough permissions to upload. Please check your server.");return;case 500:alert("The connector is disabled");break;default:alert("Error on file upload. Error number: "+c);return}SetUrl(a);GetE("frmUpload").reset()}var oUploadAllowedExtRegex=new RegExp(FCKConfig.LinkUploadAllowedExtensions,"i");var oUploadDeniedExtRegex=new RegExp(FCKConfig.LinkUploadDeniedExtensions,"i");function CheckUpload(){var a=GetE("txtUploadFile").value;if(a.length==0){alert("Please select a file to upload");return false}if((FCKConfig.LinkUploadAllowedExtensions.length>0&&!oUploadAllowedExtRegex.test(a))||(FCKConfig.LinkUploadDeniedExtensions.length>0&&oUploadDeniedExtRegex.test(a))){OnUploadCompleted(202);return false}window.parent.Throbber.Show(100);GetE("divUpload").style.display="none";return true}function SetDefaultTarget(){var a=FCKConfig.DefaultLinkTarget||"";if(oLink||a.length==0){return}switch(a){case"_blank":case"_self":case"_parent":case"_top":GetE("cmbTarget").value=a;break;default:GetE("cmbTarget").value="frame";break}GetE("txtTargetFrame").value=a};